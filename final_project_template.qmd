---
title: "Early Antibiotic Administration and Improved Outcomes in Sepsis Treatment: A MIMIC-IV Analysis"
subtitle: "BMIN5030 Final Project"
author: "Yuxuan Shi"
format: html
editor: visual
number-sections: true
embed-resources: true
---

------------------------------------------------------------------------

Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, although this is not required.

## Overview {#sec-overview}

This project primarily investigates the association between early antibiotic administration and patient outcomes among ICU patients diagnosed with sepsis using the MIMIC-IV dataset. The study aims to evaluate whether earlier intervention is associated with improved outcomes which is defined through a range of metrics, such as in-hospital mortality rate, 30-day readmission rate, ventilator-free days, and organ dysfunction progression. The goal is to identify potential clinical implications for optimizing the sepsis management processes. Some of these discrepancies stem from challenges in accurately defining the onset of sepsis, handling the time discretization for data analysis, or confounding factors such as illness severity and treatment bias.

## Introduction {#sec-introduction}

Sepsis is a leading cause of death in intensive care units (ICUs) and continues to pose major challenges to clinicians due to its complexity. Early antibiotic administration has long been considered a cornerstone of sepsis treatment, based on evidence suggesting that delays in treatment may increase mortality and worsen organ function. However, the optimal timing of antibiotic administration remains controversial, as observational studies have produced mixed results.

This project is interdisciplinary, combining insights from biomedical informatics, clinical medicine, and data science. From a clinical perspective, the project draws on principles of critical care and infectious disease management to define sepsis onset, select relevant outcomes, and interpret physiological indicators such as acuity scores (e.g. SOFA) trajectories; from a informatics standpoint, it involves working with high-dimensional EHR data and addressing issues such as timestep discretization and alignment, causal inference modeling, and other data science practices for various data processing tasks.

## Methods {#sec-methods}

To systematically investigate the relationship between early antibiotic administration and patient outcomes among ICU patients with sepsis, this study follows a structured analytic pipeline integrating cohort filtering, feature construction, temporal alignment, data pre-processing, and modeling. Note that the MIMIC-IV v3.1 database is a large-scale critical care dataset containing information on over 300,000 hospital admissions and 60,000 ICU stays from the Beth Israel Deaconess Medical Center between 2008 and 2019, encompassing millions of clinical observations, laboratory results, and charted events. While thorough and more informative, the large-scale dataset might not be suitable for proof of concept and fast iterations at early stage. In comparison, MIMIC-IV Clinical Database Demo contains only a subset of (approximately 1% of) the full data, designed to preserve the same schema and data structure while greatly reducing the volume. Hence, this study initially develops and validates the pipeline using the demo dataset, and once functional integrity and performance are confirmed, the entire pipeline will be transplanted to process the full MIMIC-IV v3.1 dataset. The overall workflow is designed as follow.

### Cohort Filtering

The study cohort will be derived from the MIMIC-IV v3.1 database, focusing on adult patients (\>= 18 years old) admitted to the intensive unit care with a clinical diagnosis of sepsis. Sepsis will be identified according to the Sepsis-3 definition—evidence of infection in conjunction with organ dysfunction, operationalized as a Sequential Organ Failure Assessment (SOFA) score \>= 2 within a 48-hour window around suspected infection. Only the first ICU admission per patient will be included to avoid within-patient correlation.

Patients will be excluded if they have missing antibiotic administration time stamps, lack key outcome data (e.g. discharge status), or have ICU stays shorter than 24 hours. This ensures temporal analyses are reliable and outcomes are meaningful for comparison.

### Feature Construction

Key variables will be constructed across multiple tables within MIMIC-IV.

-   1\) Demographic/General Features: Age, gender, ethnicity from *patients* and *admissions*.

-   2\) Clinical Characteristics: Baseline SOFA scores, comorbidities (Using the Charlson Comobidity Index), vital signals from *chartevents* and *diagnoses_icd*, Microbiology-based infection detection from *microbiologyevents.*

-   3\) Treatment Variables: Timing and dosage of first antibiotic administration, vasopressor use, and mechanical ventilation extracted from *prescriptions*, *inputevents*, and *procedureevents*.

-   4\) Outcome Variables: In-hospital mortality, 30-day readmission, ventilator-free days, and organ dysfunction progression derived from *admissions*, *icustays*, and longitudinal *chartevents*.

In summary, tables being sourced are:

-   X: *patients, admissions, chartevents, labevents, diagnoses_icd, icustays, prescriptions, inputevents, procedureevents*

-   y: *admissions.discharge_location, admissions.admittime, procedureevents, chartevents*

```{r}
library(tidyverse)
```

```{r}

data_dir <- "./physionet.org/files/mimic-iv-demo/2.2"

# loading in the demo dataset
load_mimic <- function(path) {
  read_csv(file.path(data_dir, path), show_col_types = FALSE)
}

patients <- load_mimic("hosp/patients.csv.gz")
admissions <- load_mimic("hosp/admissions.csv.gz")
icustays <- load_mimic("icu/icustays.csv.gz")
chartevents <- load_mimic("icu/chartevents.csv.gz")
labevents <- load_mimic("hosp/labevents.csv.gz")
diagnoses_icd <- load_mimic("hosp/diagnoses_icd.csv.gz")
prescriptions <- load_mimic("hosp/prescriptions.csv.gz")
inputevents <- load_mimic("icu/inputevents.csv.gz")
procedureevents <- load_mimic("icu/procedureevents.csv.gz")
emar <- load_mimic("hosp/emar.csv.gz")
microbiologyevents <- load_mimic("hosp/microbiologyevents.csv.gz")
d_items <- load_mimic("icu/d_items.csv.gz")
d_labitems <- load_mimic("hosp/d_labitems.csv.gz")
outputevents <- load_mimic("icu/outputevents.csv.gz")


mimic_demo <- list(
  patients = patients,
  admissions = admissions,
  icustays = icustays,
  chartevents = chartevents,
  labevents = labevents,
  diagnoses_icd = diagnoses_icd,
  prescriptions = prescriptions,
  inputevents = inputevents,
  procedureevents = procedureevents,
  emar = emar,
  microbiologyevents <- microbiologyevents,
  d_items = d_items,
  d_labitems = d_labitems,
  outputevents <- outputevents
)
```

```{r}
mimic_demo
```

As stated in section Cohort Filtering, we define onset of sepsis using the **Sepsis-3** criteria as "“life-threatening organ dysfunction caused by a dysregulated host response to infection.", in which "organ dysfunction can be identified as an acute change in total SOFA score \>= 2 points consequent to the infection," and "the baseline SOFA score can be assumed to be zero in patients not known to have preexisting organ dysfunction(Singer et al., JAMA 2016)”. Programmatically, the process proceeds as follows.

#### Identifying Suspected Infections

Firstly, we identify **suspected infection** using the standard antibiotic-culture pairing (blood culture collection within 24 hours after antibiotic administration, or antibiotics administered within 72 hours after culture). As shown in the code below, we first extract all systemic antibiotics from *prescriptions* table using string matching (e.g. penicillin, cephalosporin, carbapenem, etc.). Then, culture events were retrieved from *microbiologyevents*, including the collection time and specimen type. We then join two tables by subject_id and hadm_id, and filter out the antibiotic administration by time window of -24h to +72h. Lastly, since patients might have multiple antibiotic administration or cultures for same admission, all valid pairs were to reduced to a single infection onset timestamp by finding the earliest paired event timestamp (e.g. min of all min(starttime, charttime) pairs).

The resulting tibble suspected_infection_onset contains one row per admission with the following variables:

-   infection_time: earliest infection_related timestamp;

-   first_specimen: type of the first qualifying specimen;

-   n_pairs: number of valid culture-antibiotic pairs;

-   suspected_infection: TRUE/FALSE;

Along with primary keys (subject_id, hadm_id). The resulting tibble has shape (145, 6), identifying 85 distinct patients with 145 admissions. Within each admission, there were (median) 15 valid culture-antibiotic events pair within the valid time window.

```{r}
# 1) detect suspected infection: using a combination of cultres + antibiotics

# searching antibiotics related to infection
antibiotics <- prescriptions %>%
  filter(
    str_detect(
      tolower(drug),
      "penicillin|ampicillin|amoxicillin|cef|ceph|meropenem|imipenem|
       vanco|piperacillin|tazobactam|azithro|levofloxacin|cipro|
       clinda|metronidazole|linezolid|ertapenem|trimethoprim|sulfa"
    )
  ) %>%
  select(subject_id, hadm_id, starttime, stoptime, drug)

# extract culture events for later matching
cultures <- microbiologyevents %>%
  select(subject_id, hadm_id, charttime, spec_type_desc, org_name)

# pair antibiotics and cultures for suspected infections
suspected_infection <- cultures %>%
  inner_join(antibiotics, by = c("subject_id", "hadm_id")) %>%
  mutate(
    diff_hours = as.numeric(difftime(starttime, charttime, units = "hours"))
  ) %>%
  filter(diff_hours >= -24, diff_hours <= 72)  # filter only aa in -24h to +72h window

# at this step, one subject_id may map to multiple rows as multiple antibiotic administrations occured. we flatten that to map one subject_id to one admission and finds earliest infection-onset timestamp
suspected_infection_onset <- suspected_infection %>%
  group_by(subject_id, hadm_id) %>%
  summarise(
    infection_time = min(pmin(starttime, charttime, na.rm = TRUE)), # earliest infection onset
    first_specimen = first(spec_type_desc),
    n_pairs = n(),
    .groups = "drop"
  ) %>%
  mutate(suspected_infection = TRUE)

suspected_infection_onset %>%
  summarise(
    n_patients = n_distinct(subject_id),
    n_admissions = n_distinct(hadm_id),
    median_pairs = median(n_pairs)
  )

head(suspected_infection_onset)

```

#### Computing SOFA Trajectories

We then compute **SOFA** trajectories for each admission. SOFA (Sepsis-related Organ Failure Assessment) as originally proposed by Vincent et al. (1996, *Intensive Care Medicine*, 22:707-710), evaluates six organ systems: respiratory, coagulation, liver, cardiovascular, central nervous, and real; assigning 0-4 points to each based on the degree of abnormality. The total SOFA score has a bound of 0-24. The exact variables can be retrived from tables *labevents* and *chartevents*.

It is worth noting that computing SOFA from real ICU data retrospectively requires nontrivial temporal discretization and alignment, as measurements occur at irregular, clinically driven intervals. Different SOFA components are sampled at very different frequencies (e.g., blood gases every few hours, bilirubin once per day), making naive time alignment (e.g., 1 hour binning) inappropriate and lead to information distortion. Prior literature has generally converged to fixed-binning: determine a bin width (e.g., 1h, 4h), aggregate all information within the window and uses max/min/median for abnormal vitals. Upon missing entry, carried-forward/backward imputation is implemented to use most recent available value within some window (e.g., 24h for labs, 6h for vitals).

As an example, the [official SOFA table](https://github.com/MIT-LCP/mimic-code/blob/main/mimic-iv/concepts/score/sofa.sql) generated by MIT-LCP MIMIC-IV team uses hourly bins to calculate SOFA score hourly. For each hour of an ICU stay, all SOFA-relevant variables are aggregated within that hour; and when multiple observations are present, worst values are selected (e.g., minimum GCS). Since most lab tests are sampled infrequently, this approach produces sparse results with majority of hourly SOFAs to be NULL. To workaround this issue, the team also applies a 24-hour rolling window to record the worst observation within.

As proposed by a recent paper *Off by a Beat: Temporal Misalignment in Offline RL for Healthcare,* the author argues that this alignment technique is problematic as it allows for information on patient's future trajectory to be leaked into current time step; effectively, for sequential decision-making and real-time prediction tasks, the optimal treatment learned would be inaccurate.

To better capture the nuances in computing SOFA trajectories, we start by studying the sample interval distribution for all relevant intervals.

```{r}

# 2) detect organ failing: SOFA score

# 2.a) filter out a tibble that contains all variables needed to compute SOFA
library(dplyr)
library(tidyr)
library(lubridate)
library(stringr)

# select first ICU stay per subject; scope down to only suspected infection patients
infected_icustays <- icustays %>%
  inner_join(
    suspected_infection_onset %>% select(subject_id, hadm_id),
    by = c("subject_id", "hadm_id")
  ) %>%
  group_by(subject_id, hadm_id) %>% 
  arrange(intime) %>%
  slice(1) %>%
  ungroup() %>%
  select(subject_id, hadm_id, stay_id, intime, outtime)

infected_icustays
```

Next, define the variables needed for calculating SOFA score and their related source tables. For each component, the associated response were shown and object created to be used in the next section:

-   Respiratory: PaO~2~, FiO~2.~ *labevents, chartevents*

```{r}
d_labitems %>% filter(itemid == 50821)
d_items %>% filter(itemid == 223835)

paO2_itemids <- c(50821)
fio2_itemids <- c(223835)
```

-   Coagulation: Platelet Count. *labevents*

```{r}
d_labitems %>% filter(itemid == 51265)

platelet_itemids <- c(51265)
```

-   Liver: Bilirubin. labevents

```{r}
d_labitems %>% filter(itemid == 50885)

bilirubin_itemids <- c(50885)
```

-   Cardiovascular: Mean Arterial Pressure (map, invasive/non-invasive), AND/OR vasopressor doses (norepinephrine, epinephrine, dopamine, dobupamine).

```{r}
d_items %>% filter(itemid == 220052)
d_items %>% filter(itemid == 220181)

map_itemids <- c(220052, 220181)

# vasopressor doses
d_items %>% filter(itemid == 221906)
d_items %>% filter(itemid == 221289)
d_items %>% filter(itemid == 221662)
d_items %>% filter(itemid == 221653)

norepi_itemids <- c(221906)
epi_itemids    <- c(221289)
dopamine_itemids <- c(221662)
dobutamine_itemids <- c(221653)
```

-   Central Nervous System: Glasgow coma scale (eye/verbal/motor). *chartevents*

```{r}
d_items %>% filter(itemid == 220739) # eye
d_items %>% filter(itemid == 223901) # motor
d_items %>% filter(itemid == 223900) # verbal

gcs_eye_itemids    <- c(220739)
gcs_motor_itemids  <- c(223901)
gcs_verbal_itemids <- c(223900)
```

-   d_items %\>% filter(itemid == 223901) \# motorRenal: Creatinine OR urine. *labevents, chartevents*

```{r}
d_labitems %>% filter(itemid == 50912)

# urine outputs
d_items %>% filter(itemid == 226559)
d_items %>% filter(itemid == 226560)
d_items %>% filter(itemid == 226561)
d_items %>% filter(itemid == 226563)
d_items %>% filter(itemid == 226584)


creatinine_itemids <- c(50912)
urine_itemids <- c(226559, 226560, 226561, 226563, 226584)
```

```{r}
# extract labs needed for SOFA
labs_raw <- labevents %>%
  semi_join(infected_icustays, by = c("subject_id", "hadm_id")) %>%
  filter(itemid %in% c(paO2_itemids,
                       platelet_itemids,
                       bilirubin_itemids,
                       creatinine_itemids)) %>%
  mutate(
    var_name = case_when(
      itemid %in% paO2_itemids         ~ "paO2",
      itemid %in% platelet_itemids     ~ "platelets",
      itemid %in% bilirubin_itemids    ~ "bilirubin",
      itemid %in% creatinine_itemids   ~ "creatinine",
      TRUE ~ NA_character_
    ),
    charttime = charttime
  ) %>%
  select(subject_id, hadm_id, charttime, var_name, value = valuenum)


# extract vital signs + FiO2 + GCS + MAP from chartevents
# join using icu stay id
chartevents_raw <- chartevents %>%
  semi_join(infected_icustays, by = c("subject_id", "stay_id")) %>%
  filter(itemid %in% c(
    fio2_itemids,
    map_itemids,
    gcs_eye_itemids,
    gcs_motor_itemids,
    gcs_verbal_itemids
  )) %>%
  mutate(
    var_name = case_when(
      itemid %in% fio2_itemids ~ "fio2",
      itemid %in% map_itemids ~ "map",
      itemid %in% gcs_eye_itemids ~ "gcs_eye",
      itemid %in% gcs_motor_itemids ~ "gcs_motor",
      itemid %in% gcs_verbal_itemids ~ "gcs_verbal",
      TRUE ~ NA_character_
    ),
    charttime = charttime,
    value = valuenum
  ) %>%
  select(subject_id, hadm_id, charttime, var_name, value)

# extract vasopressors from procedureevents or inputevents
# join using icu stay id
vasopressor_raw <- inputevents %>%
  semi_join(infected_icustays, by = c("subject_id", "stay_id")) %>%
  filter(itemid %in% c(norepi_itemids,
                       epi_itemids,
                       dopamine_itemids,
                       dobutamine_itemids)) %>%
  mutate(
    var_name = case_when(
      itemid %in% norepi_itemids ~ "norepinephrine",
      itemid %in% epi_itemids ~ "epinephrine",
      itemid %in% dopamine_itemids ~ "dopamine",
      itemid %in% dobutamine_itemids ~ "dobutamine",
      TRUE ~ NA_character_
    ),
    charttime = starttime,
    value = amount
  ) %>%
  select(subject_id, hadm_id, charttime, var_name, value)

# extract urine output from chartevents
# join using stay id
urine_raw <- outputevents %>%
  semi_join(infected_icustays, by = c("subject_id", "stay_id")) %>%
  filter(itemid %in% urine_itemids) %>%
  mutate(
    var_name = "urine_output",
    value = value,
    charttime = charttime
  ) %>%
  select(subject_id, hadm_id, charttime, var_name, value)

# combine
sofa_raw_vars <- bind_rows(
  labs_raw,
  chartevents_raw,
  vasopressor_raw,
  urine_raw
) %>%
  arrange(subject_id, hadm_id, charttime)

head(sofa_raw_vars)
```

```{r}
# quick sanity check. all variables are intact.
unique(sofa_raw_vars$var_name)
```

Then, we perform an analysis of sampling intervals for all SOFA related variables.

```{r}

# 2.b) get sampling intervals (per subject, per hadm, per variable)
intervals <- sofa_raw_vars %>%
  arrange(subject_id, hadm_id, var_name, charttime) %>%
  group_by(subject_id, hadm_id, var_name) %>%
  mutate(
    prev_time = lag(charttime),
    diff_mins = as.numeric(difftime(charttime, prev_time, units = "mins"))
  ) %>%
  ungroup() %>%
  filter(!is.na(diff_mins) & diff_mins > 0)   # remove first obs & nonpositive diffs

# summarize interval statistics per variable

interval_summary <- intervals %>%
  group_by(var_name) %>%
  summarise(
    n = n(),
    median_min = median(diff_mins),
    p25_min = quantile(diff_mins, 0.25),
    p75_min = quantile(diff_mins, 0.75),
    min_min = min(diff_mins),
    max_min = max(diff_mins)
  ) %>%
  arrange(median_min)

interval_summary


# viz
# violin Plot of sampling intervals (log-scale)

ggplot(intervals, aes(x = var_name, y = diff_mins)) +
  geom_violin(fill = "skyblue", alpha = 0.6) +
  geom_boxplot(width = 0.1, outlier.alpha = 0.15) +
  scale_y_log10() +
  theme_bw() +
  labs(
    title = "Distribution of Sampling Intervals per Variable",
    x = "SOFA Variable",
    y = "Interval (minutes, log scale)"
  )

ggplot(intervals, aes(x = diff_mins)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7) +
  scale_x_log10() +
  facet_wrap(~ var_name, scales = "free_y") +
  theme_bw() +
  theme(
    plot.margin = margin(5.5, 5.5, 20, 5.5),  # extra room bottom
    axis.text.x = element_text(angle = 45, hjust = 1, size = 6)
  ) +
  labs(
    title = "Sampling Interval Histograms per Variable (log scale)",
    x = "Interval (minutes)",
    y = "Count"
  )

```

As shown in the two plots, there are great variance in sample intervals across different variables. Variables such as **map** and **FiO~2~** were sampled in a regular pattern, with high counts clustered at fixed interval time. Variables such as **doubutamine** and **epinephrine** were sampled more irregularly and less frequently. The general sample interval is also of varying length; variables such as **bilirubin**, **platelets**, and **creatinine** (laboratory reports) were collected on daily basis (16\~20 hours). Hence, given the substantial heterogeneity in sampling intervals, I decided not to discretize data into fixed time windows, but perform a procedural minimum-prefix search with backward-looking records to identify those that satisfied the condition described in Sepsis-3.

For each admission, a running records of all observed variables would be maintained along with current SOFA score. Whenever a new observation arrives, SOFA score would be updated and check whether the change \>= 2. If true, the updated time stamp would be considered sepsis onset. Note that our search is conducted on a subset of suspected infection patients, and according to Sepsis-3 the baseline SOFA should be 0. Hence, the goal for the search is to find (if any) the earliest SOFA score \>= 2.

@draft: comparing to the official implementation, this one 1) does not impute by worst number, which is more accurate; 2) optimized for SOFA change detection

@todo: keep notes that some of the earliest entry might be tagged since SOFA change immediately \>= 2 as with baseline being one. report also number of these cases and percentage of it.

```{r}
# 2.c) procedural search to identify SOFA change >= 2

```

### Temporal Alignment and Grouping

Accurate temporal alignment is critical for causal inference in clinical settings, which includes three significant alignment procedures. 1) Sepsis Onset, defined as the earliest time when both infection and SOFA \>= 2 criteria are satisfied; 2) Antibiotic Administration, timestamped from *prescriptions.starttime* or *inputeevents.starttime*. 3) Time-to-Antibiotic: Computed as the difference between antibiotic initiation and sepsis onset.

Patients will be categorized into Early (TTA \<= 3 hours) and late (TTA \>= 3 hours) treatment groups, consistent with Surviving Sepsis Campaign (SSC) guidelines. Sensitivity analyses will explore alternate thresholds (e.g., 1h, 6h) to assess robustness).

## Results {#sec-results}

Describe your results and include relevant tables, plots, and code/comments used to obtain them. You may refer to the @sec-methods as needed. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

## Conclusion

This the conclusion. The @sec-results can be invoked here.

## Reference

<https://pmc.ncbi.nlm.nih.gov/articles/PMC4968574/>

<https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&arnumber=10803371>

<https://pubmed.ncbi.nlm.nih.gov/26903338/>

<https://pubmed.ncbi.nlm.nih.gov/8844239/>
